<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservia - Resource Reservation System</title>
    <script src="{{ url_for('static', filename='js/jquery/jquery-3.6.0.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='js/jquery-ui/jquery-ui.min.css') }}">
    <script src="{{ url_for('static', filename='js/jquery-ui/jquery-ui.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/crypto_utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/session_manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/reservia.js') }}"></script>
    <script src="{{ url_for('static', filename='js/resource_manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/test_frontend.js') }}"></script>
</head>
<body>
    <div id="title-container" style="background-color: white; padding: 20px; text-align: center; margin-bottom: 10px; border-radius: 10px;">
        <h1>Reservia</h1>
    </div>

    <div id="header" style="background-color: white; padding: 15px; text-align: left; border-radius: 10px;">
        <button id="login-btn" style="margin-right:10px;">Login</button>
        <button id="logout-btn" style="margin-right:10px;">Logout</button>
        <button id="modify-btn" style="margin-right:10px; display:none;">Modify</button>
    </div>

    <div id="login-form" style="display:none;">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button id="login-submit">Login</button>
        <button id="login-cancel">Cancel</button>
        <div id="login-error" style="color:red; display:none;"></div>
    </div>

    <div id="modify-form" style="display:none;">
        <h2 id="modify-title">Modify User Data</h2>
        <input type="email" id="modify-email" placeholder="New Email (optional)">
        <input type="password" id="modify-password" placeholder="New Password (optional)">
        <button id="modify-submit">Modify</button>
        <button id="modify-cancel">Cancel</button>
        <div id="modify-error" style="color:red; display:none;"></div>
        <div id="modify-success" style="color:green; display:none;"></div>
    </div>

    <div id="main-content">
        <p>Welcome to Reservia Resource Reservation System</p>
    </div>
    <div id="resource-pool-container">

    </div>

    <script>
        $(document).ready(function() {
            // Initialize jQuery UI elements
            $('button').button();
            $('#login-form').dialog({
                autoOpen: false,
                modal: true,
                width: 350,
                resizable: false,
                draggable: true,
                title: 'Login to Reservia'
            });
            
            $('#modify-form').dialog({
                autoOpen: false,
                modal: true,
                width: 400,
                resizable: false,
                draggable: true,
                title: 'Modify User Data'
            });

            console.log('Page loaded, checking session...');
            checkSession();

            $('#login-btn').click(function() {
                showLoginForm();
            });

            $('#logout-btn').click(function() {
                logout();
            });

            $('#login-submit').click(function() {
                login();
            });

            $('#login-cancel').click(function() {
                hideLoginForm();
            });

            $('#modify-btn').click(function() {
                showModifyForm();
            });

            $('#modify-submit').click(function() {
                modifyUser();
            });

            $('#modify-cancel').click(function() {
                hideModifyForm();
            });

            // Initialize ResourcePool
            ResourcePool.getInstance();

            // Initialize resource manager (event listeners only - no auto-refresh until login)
            initializeResourceManager();
        });



        // ===== WINDOW RESIZE HANDLER =====
        // Update layout when window is resized
        $(window).resize(function() {
            ResourcePool.getInstance().updateLayout();
        });

        function checkSession() {
            $.ajax({
                url: '/session/status',
                method: 'GET',
                success: function(response) {
                    console.log('Session check response:', response);
                    if (response.logged_in) {
                        showLoggedInUI(response);
                    } else {
                        showLoggedOutUI();
                    }
                },
                error: function(xhr, status, error) {
//                    console.log('Session check error:', xhr.status, status, error);
                    showLoggedOutUI();
                }
            });
        }

        async function login() {
            const username = $('#username').val();
            const password = $('#password').val();

            if (!username || !password) {
                showError('Please enter username and password');
                return;
            }

            try {
                // Hash password on client side before sending
                const hashedPassword = await hashPassword(password);
                
                $.ajax({
                    url: '/session/login',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({name: username, password: hashedPassword}),
                    success: function(response) {
                        hideLoginForm();
                        checkSession(); // Refresh session data
                        clearError();
                    },
                    error: function(xhr) {
                        showError('Login failed');
                    }
                });
            } catch (error) {
                showError('Password hashing failed');
            }
        }

        function logout() {
            $.ajax({
                url: '/session/logout',
                method: 'POST',
                success: function() {
                    showLoggedOutUI();
                },
                error: function() {
                    showLoggedOutUI();
                }
            });
        }

        function showLoggedInUI(response) {
            // Update global session data
            SessionManager.setSessionData(response);

            $('#login-btn').hide();
            $('#logout-btn').show();
            $('#modify-btn').show();

            // Admin warning is handled by SessionManager.setSessionData()

            const tooltipContent = `<b>${response.user_name}</b><br>user_id: ${response.user_id}<br>user_email: ${response.user_email}<br>is_admin: ${response.is_admin}`;
            $('#logout-btn').attr('title', tooltipContent).tooltip({
                content: tooltipContent,
                position: { my: "left top+15", at: "left bottom" }
            });

            // Load resources and start auto-refresh for logged-in user
            loadResourcesFromServer();
            startAutoRefresh();
        }

        function showLoggedOutUI() {
            // Clear global session data
            SessionManager.clearSessionData();

            $('#login-btn').show();
            $('#logout-btn').hide();
            $('#modify-btn').hide();

            // Admin warning reset is handled by SessionManager.clearSessionData()

            // Only destroy tooltip if it was initialized
            if ($('#logout-btn').data('ui-tooltip')) {
                $('#logout-btn').tooltip('destroy');
            }

            hideLoginForm();
            hideModifyForm();

            // Stop auto-refresh and clear resources for logged-out user
            stopAutoRefresh();
            clearResourcesOnLogout();
        }

        function showLoginForm() {
            $('#login-form').dialog('open');
            $('#username').val('');
            $('#password').val('');
            clearError();
        }

        function hideLoginForm() {
            $('#login-form').dialog('close');
            clearError();
        }

        function showError(message) {
            $('#login-error').text(message).show();
        }

        function clearError() {
            $('#login-error').hide();
        }

        function showModifyForm() {
            const userName = getCurrentUserNameFromTooltip();
            const title = userName ? `Modify ${userName} Data` : 'Modify User Data';
            $('#modify-title').text(title);
            $('#modify-form').dialog('open');
            $('#modify-email').val('');
            $('#modify-password').val('');
            clearModifyMessages();
        }

        function hideModifyForm() {
            $('#modify-form').dialog('close');
            clearModifyMessages();
        }

        async function modifyUser() {
            const email = $('#modify-email').val();
            const password = $('#modify-password').val();

            if (!email && !password) {
                showModifyError('Please enter at least one field to modify');
                return;
            }

            const currentUserId = getCurrentUserIdFromTooltip();
            if (!currentUserId) {
                showModifyError('Unable to get current user ID');
                return;
            }

            try {
                const data = { user_id: currentUserId };
                if (email) data.email = email;
                if (password) {
                    // Hash password on client side before sending
                    data.password = await hashPassword(password);
                }

                $.ajax({
                    url: '/admin/user/modify',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(response) {
                        showModifySuccess('User data modified successfully');
                        // Update session data by checking session again
                        setTimeout(() => {
                            checkSession();
                            hideModifyForm();
                        }, 1500);
                    },
                    error: function(xhr) {
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            showModifyError(errorResponse.error || 'Modification failed');
                        } catch (e) {
                            showModifyError('Modification failed');
                        }
                    }
                });
            } catch (error) {
                showModifyError('Password hashing failed');
            }
        }

        function getCurrentUserIdFromTooltip() {
            return SessionManager.getCurrentUserId();
        }

        function getCurrentUserNameFromTooltip() {
            return SessionManager.getCurrentUserName();
        }

        function showModifyError(message) {
            $('#modify-error').text(message).show();
            $('#modify-success').hide();
        }

        function showModifySuccess(message) {
            $('#modify-success').text(message).show();
            $('#modify-error').hide();
        }

        function clearModifyMessages() {
            $('#modify-error').hide();
            $('#modify-success').hide();
        }

        // Auto-logout on session expiry
        $(document).ajaxError(function(event, xhr, settings) {
            if (xhr.status === 401 && settings.url !== '/session/status') {
                showLoggedOutUI();
                showError('Session expired. Please log in again.');
            }
        });
    </script>
</body>
</html>